# Алгоритм полного анализа по Валееву
Универсальный пошаговый алгоритм для любого инструмента.

## Шаг 0: Подготовка данных
**Требования к данным**
- Таймфреймы: D1, H4, H1 (все три обязательны).
- История: минимум 2 месяца.
- Колонки: `timestamp`, `Open`, `High`, `Low`, `Close`.

**Настройки визуализации**
- Масштаб: последние 2 месяца занимают 80-90% экрана.
- На графике: только цена + зоны (без индикаторов).

---

## Шаг 1: Анализ D1 (дневной график)

### 1.1. Расчет AvgRange для D1
**Формула**
1. Взять последние 20 свечей D1.
2. Для каждой свечи: `Range = High - Low`.
3. `AvgRange = среднее(Range всех 20 свечей)`.
4. Минимальный отход = `1.5 × AvgRange`.

### 1.2. Определение важных экстремумов D1
**Правило**
Экстремум считается важным, если:
1) это локальный минимум или максимум,
2) после экстремума цена ушла ≥ минимального отхода.

**Проверка для минимума**
1. Найти свечу с самым низким `Low` в окрестности ±3 свечи.
2. Проверить движение вверх после минимума:
   - Максимальный `High` в следующие 5 свечей.
   - Разница `(High_max - Low_min) ≥ минимального отхода`.

**Проверка для максимума**
1. Найти свечу с самым высоким `High` в окрестности ±3 свечи.
2. Проверить движение вниз после максимума:
   - Минимальный `Low` в следующие 5 свечей.
   - Разница `(High_max - Low_min) ≥ минимального отхода`.

### 1.3. Построение зон D1
**Для каждого важного экстремума**

Если **максимум** (сопротивление):
- Верх зоны = `High` экстремума.
- Низ зоны = `Close` свечи экстремума.
- Если соседняя свеча ближе к `High` → взять ее `Close`.

Если **минимум** (поддержка):
- Низ зоны = `Low` экстремума.
- Верх зоны = `Close` свечи экстремума.
- Если соседняя свеча ближе к `Low` → взять ее `Close`.

### 1.4. Определение тренда D1
**Правила**

1) **Восходящий тренд**:
- Higher High (HH): каждый следующий максимум выше предыдущего.
- Higher Low (HL): каждый следующий минимум выше предыдущего.
- Минимум 3 последовательных HH + HL.

2) **Нисходящий тренд**:
- Lower Low (LL): каждый следующий минимум ниже предыдущего.
- Lower High (LH): каждый следующий максимум ниже предыдущего.
- Минимум 3 последовательных LL + LH.

3) **Боковик**:
- Нет последовательности HH/HL или LL/LH.
- Цена колеблется в диапазоне ±2% от среднего.
- Минимум 10 свечей в боковике.

---

## Шаг 2: Анализ H4 (4-часовой график)

### 2.1. Расчет фигуры для H4
Повторить шаг 1.1 для H4:
1. Взять последние 20 свечей H4.
2. Рассчитать `AvgRange_H4`.
3. Минимальный отход = `1.5 × AvgRange_H4`.

### 2.2. Поиск важных экстремумов H4
Повторить шаг 1.2 для H4:
- Минимальный отход = `AvgRange_H4 × 1.5`.
- Окрестность для локальных экстремумов: ±5 свечей H4.
- Проверять движение после экстремума: 10 свечей H4 (40 часов).

### 2.3. Кластеризация уровней H4
**Алгоритм кластеризации**
1. Взять все важные экстремумы H4.
2. Отсортировать по цене (от меньшего к большему).
3. Объединять в кластер, если:
   - Разница в цене ≤ `0.5 × AvgRange_H4`.
   - Тип экстремума одинаковый (все минимумы или все максимумы).

**Для каждого кластера**
- Минимальная и максимальная цена.
- Сила кластера = количество экстремумов в нем.
- Ширина кластера = `max_price - min_price`.

### 2.4. Уточнение зон
Для каждого кластера:
1. Найти самый ранний экстремум в кластере.
2. Построить зону по правилу шага 1.3.
3. Расширить зону до границ кластера.

### 2.5. Проверка свежести уровней
Для каждой зоны H4:
1. Взять последние 20 свечей H4.
2. Посчитать касания зоны:
   - Касание = свеча задела зону (`High ≥ низ зоны` и `Low ≤ верх зоны`).

Оценка свежести:
- 0-2 касания: свежий, сильный.
- 3-4 касания: ослабевает.
- 5+ касаний: заезженный, готов к пробою.

---

## Шаг 3: Связка D1 и H4

### 3.1. Нахождение пересечений
Для каждой зоны H4:
1. Проверить пересечение с зонами D1.
2. Пересечение = зоны перекрываются хотя бы на 30%.

Если есть пересечение:
- Уровень получает статус **приоритетный**.
- Сила = сила_H4 + сила_D1.

### 3.2. Определение позиции цены
Текущая цена относительно D1 диапазона:
1. Найти диапазон D1:
   - Если тренд: канал тренда.
   - Если боковик: `min(Low последних 20 свечей)` — `max(High последних 20 свечей)`.

2. Разделить диапазон на трети:
- Нижняя треть: нижние 33% диапазона.
- Средняя треть: средние 34% диапазона.
- Верхняя треть: верхние 33% диапазона.

3. Определить позицию цены:
- У границы (нижняя/верхняя треть) → можно торговать.
- В середине (средняя треть) → не торговать.

### 3.3. Поиск ближайших уровней
Для текущей цены:
1. Найти все зоны H4 в пределах ±`2 × AvgRange_H4`.
2. Отсортировать по расстоянию до цены.
3. Выделить:
- ближайшую поддержку снизу,
- ближайшее сопротивление сверху.

---

## Шаг 4: Формирование торгового плана

### 4.1. Условия для торговли
**Все условия должны быть выполнены:**
1. Цена у границы диапазона D1 (нижняя/верхняя треть).
2. Цена в зоне H4 (±`0.5 × AvgRange_H4` от границы зоны).
3. Зона свежая (0-4 касания за последние 20 свечей H4).
4. На H1 есть паттерн (Pin-bar, Key Reversal).

### 4.2. Определение направления
**Если цена у нижней границы:**
- Направление: BUY.
- Вход: верхняя часть зоны поддержки.
- Стоп: 5-10 пунктов ниже низа зоны.
- TP1: ближайшее сопротивление H4.
- TP2: противоположная граница диапазона D1.

**Если цена у верхней границы:**
- Направление: SELL.
- Вход: нижняя часть зоны сопротивления.
- Стоп: 5-10 пунктов выше верха зоны.
- TP1: ближайшая поддержка H4.
- TP2: противоположная граница диапазона D1.

### 4.3. Расчет позиции
**Формула**
1. Риск на сделку = 2% от депозита.
2. Стоп в пунктах = расстояние от входа до стоп-лосса.
3. Стоимость пункта = шаг цены × стоимость шага.
4. Риск на контракт = стоп × стоимость пункта.
5. Количество контрактов = риск на сделку / риск на контракт.
6. Округлить в меньшую сторону.

---

## Шаг 5: Заполнение шаблона анализа

```markdown
# АНАЛИЗ [ИНСТРУМЕНТ] [ДАТА]

## 1. D1 АНАЛИЗ
- Тренд: [Восходящий/Нисходящий/Боковик]
- Диапазон: [min]-[max]
- Важные уровни:
  - Поддержка: [цена]-[цена] (сила: [N])
  - Сопротивление: [цена]-[цена] (сила: [N])

## 2. H4 АНАЛИЗ
- Ключевые зоны:
  - Поддержка: [цена]-[цена] (свежесть: [X] касаний)
  - Сопротивление: [цена]-[цена] (свежесть: [X] касаний)
- Пересечения с D1: [список]

## 3. ТЕКУЩАЯ СИТУАЦИЯ
- Цена: [цена]
- Позиция в диапазоне D1: [нижняя/средняя/верхняя треть]
- Ближайшие уровни:
  - Поддержка: [цена] ([расстояние] пунктов)
  - Сопротивление: [цена] ([расстояние] пунктов)

## 4. ТОРГОВЫЙ ПЛАН
- Можно торговать: [Да/Нет]
- Причина: [если нет]
- Направление: [BUY/SELL] (если да)
- Уровень входа: [цена]-[цена]
- Стоп-лосс: [цена]
- Тейк-профиты: [цена], [цена]
- Размер позиции: [N] контрактов
```

---

## Шаг 6: Проверка и валидация

### 6.1. Контрольный список перед торговлей
- ✅ Тренд D1 определен.
- ✅ Цена у границы диапазона D1.
- ✅ Цена в зоне H4.
- ✅ Зона свежая (≤4 касания).
- ✅ Есть паттерн на H1.
- ✅ Риск ≤ 2% от депозита.
- ✅ Стоп за уровнем.
- ✅ Нет важных новостей в ближайшие 4 часа.
- ✅ Психологическое состояние спокойное.

### 6.2. Частые ошибки
- ❌ Торговля в середине диапазона.
- ❌ Торговля против тренда D1.
- ❌ Заезженные уровни (5+ касаний).
- ❌ Стоп меньше 5 пунктов от уровня.
- ❌ Риск более 5% на сделку.
- ❌ Вход без паттерна на H1.

---

## Шаг 7: Обновление анализа

### 7.1. Когда обновлять
**Обязательно**
1. После закрытия каждой свечи D1 (раз в день).
2. После закрытия каждой свечи H4 (4 раза в день).
3. При подходе цены к ключевому уровню.

**По желанию**
1. После важных новостей.
2. При изменении тренда D1.
3. При пробое ключевого уровня.

### 7.2. Что обновлять
1. Пересчитать AvgRange (скользящее окно 20 свечей).
2. Проверить свежесть уровней (касания за последние 20 свечей H4).
3. Обновить позицию цены в диапазоне.
4. Проверить условия для торговли.

---

## Краткий алгоритм (чек-лист)
- D1: определить тренд (HH/HL или LL/LH или боковик).
- D1: найти диапазон (min и max последних 20 свечей).
- D1: построить 2-3 ключевых зоны по важным экстремумам.
- H4: найти кластеры уровней.
- H4: проверить свежесть (касания за 20 свечей).
- Связь: найти пересечения зон D1 и H4.
- Позиция: определить где цена (низ/середина/верх диапазона).
- Решение: торговать только если цена у границы + есть уровень + есть паттерн.

**Формула принятия решения**
```
МОЖНО ТОРГОВАТЬ =
  (цена_у_границы_D1 == True)
  И (цена_в_зоне_H4 == True)
  И (зона_свежая == True)
  И (паттерн_H1 == True)
```

---

## Шаблон для заполнения

```markdown
[ДАТА АНАЛИЗА] [ИНСТРУМЕНТ]

D1:
- Тренд:
- Диапазон:
- Уровень 1:
- Уровень 2:

H4:
- Уровень 1: (касания: )
- Уровень 2: (касания: )
- Пересечение с D1:

Текущее:
- Цена:
- В диапазоне D1:
- До поддержки:
- До сопротивления:

Решение:
- Торговать: Да/Нет
- Направление:
- Причина:

План:
- Вход:
- Стоп:
- ТП1:
- ТП2:
- Лот:
```

**Важно:** алгоритм применяется строго последовательно. Если на любом шаге условие не выполняется — не торговать. Дисциплина важнее прибыли в отдельной сделке.
